<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- V5.0 Mobile-Ready Viewport: é–å®šç¸®æ”¾ã€é©é…ç€æµ·å± -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings: è®“ç¶²é åƒ App ä¸€æ¨£é‹è¡Œ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>DreamVoyage V5.0 | Mobile Ready Ultimate</title>
    
    <!-- Google Fonts (ä¿ç•™ä½†è¨­ç‚ºéé˜»å¡ï¼Œå„ªåŒ–å¤§é™¸è¨ªå•) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-yellow: #fbce1e;
            --primary-dark: #020617;
            --accent-orange: #f59e0b;
            --bg-soft: #fffef2;
            --card-shadow: 0 15px 35px rgba(251, 206, 30, 0.12);
            --border-light: #f1f5f9;
            --nav-height: 75px;
            --footer-height: 90px;
            /* Step 4 Colors */
            --teal-main: #0d9488;
            --teal-light: #ccfbf1;
            --dark-card-bg: #0f172a;
        }

        /* è®“æ‰€æœ‰å…ƒç´ å…·æœ‰æ›´æ»‘é †çš„éæ¸¡ï¼Œä¸¦ç¦æ­¢æ–‡å­—é¸å–ä»¥åƒ App */
        * { 
            box-sizing: border-box; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤æ‰‹æ©Ÿé»æ“Šè—æ¡† */
        }

        body {
            /* å„ªå…ˆä½¿ç”¨ç³»çµ±å­—é«”ä»¥å„ªåŒ–å¤§é™¸åœ°å€é«”é©—ï¼ŒGoogle Fonts ç‚ºå¾Œå‚™ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, 'Quicksand', 'Noto Sans TC', sans-serif;
            background: var(--bg-soft);
            margin: 0;
            color: var(--primary-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* é˜²æ­¢ iOS å½ˆæ€§æ²å‹•å°è‡´èƒŒæ™¯ç©¿å¹« */
            overscroll-behavior: none;
        }

        /* å°è¦½åˆ— */
        nav {
            height: var(--nav-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px; /* æ‰‹æ©Ÿç‰ˆé‚Šè·å„ªåŒ– */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.02);
            border-bottom: 3px solid var(--primary-yellow);
            padding-top: env(safe-area-inset-top); /* é¿é–‹ç€æµ· */
        }

        .nav-steps { display: flex; gap: 8px; overflow-x: auto; padding-right: 10px; scrollbar-width: none; }
        .nav-steps::-webkit-scrollbar { display: none; }

        .step-btn {
            padding: 8px 16px;
            border: none;
            background: #f1f5f9;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            color: #64748b;
            font-size: 0.85rem;
            white-space: nowrap; /* é˜²æ­¢æ‰‹æ©Ÿæ›è¡Œ */
        }

        .step-btn.active {
            background: var(--primary-yellow);
            color: var(--primary-dark);
            box-shadow: 0 5px 15px rgba(251, 206, 30, 0.3);
        }

        .nav-utils { display: flex; gap: 8px; flex-shrink: 0; }

        .util-btn {
            background: white;
            border: 2px solid var(--primary-yellow);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--primary-dark);
            white-space: nowrap;
        }
        .util-btn:hover { background: var(--primary-yellow); transform: translateY(-2px); }

        .container {
            max-width: 1350px;
            margin: 0 auto;
            padding: 15px; /* æ‰‹æ©Ÿç‰ˆå…§è·å¾®èª¿ */
            flex: 1;
            width: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch; /* iOS æ»‘å‹•æ…£æ€§ */
        }

        .section { display: none; height: 100%; animation: fadeIn 0.4s ease; }
        .section.active { display: flex; flex-direction: column; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 20px; /* æ‰‹æ©Ÿç‰ˆå…§è·å„ªåŒ– */
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border: 1px solid rgba(251, 206, 30, 0.05);
        }

        h2 { font-size: 1.4rem; margin: 0 0 15px 0; color: var(--primary-dark); }

        input, select, textarea {
            padding: 10px 14px;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            font-size: 16px; /* é˜²æ­¢ iOS è¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§ */
            outline: none;
            background: #fff;
            width: 100%;
            height: 46px;
            font-family: inherit;
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        input:focus, textarea:focus, select:focus { 
            border-color: var(--primary-yellow); 
            background: #fffef5; 
            box-shadow: 0 0 0 4px rgba(251, 206, 30, 0.1);
        }

        .btn-main {
            background: var(--primary-yellow);
            color: var(--primary-dark);
            border: none;
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            font-size: 1.1rem;
            box-shadow: 0 8px 25px rgba(251, 206, 30, 0.2);
            -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æŒ‰éˆ•æ¨£å¼ */
        }

        /* --- Step 2 & 4 Shared UI --- */
        .day-nav-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
            background: white;
            padding: 22px 15px 12px; 
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid #f1f5f9;
        }

        .nav-arrow {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #64748b;
            flex-shrink: 0;
            margin-top: 18px;
        }
        .nav-arrow:hover:not(:disabled) { background: var(--primary-yellow); color: var(--primary-dark); }
        .nav-arrow:disabled { opacity: 0.2; cursor: not-allowed; }

        .day-tabs-container {
            display: flex;
            gap: 12px;
            overflow-x: auto; 
            padding: 25px 5px 10px;
            flex: 1;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .day-tab {
            padding: 10px 20px;
            background: #f8fafc;
            border: 2px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 700;
            color: #64748b;
            font-size: 0.85rem;
            position: relative;
            flex-shrink: 0;
        }
        .day-tab.active {
            background: var(--primary-yellow);
            color: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(251, 206, 30, 0.25);
        }
        .day-tab.is-today {
            border-color: var(--accent-orange);
            overflow: visible;
        }
        .day-tab.is-today::after {
            content: "TODAY";
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            background: var(--accent-orange);
            color: white;
            padding: 2px 7px;
            border-radius: 6px;
            font-weight: 800;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 8px rgba(245, 158, 11, 0.4);
            z-index: 10;
            white-space: nowrap;
        }

        .item-row {
            display: grid;
            grid-template-columns: 140px 1.5fr 140px 2.2fr 120px 45px;
            gap: 15px;
            margin-bottom: 12px;
            align-items: center;
            background: #fff;
            padding: 12px 18px;
            border-radius: 20px;
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        .item-row:hover {
            border-color: var(--primary-yellow);
            box-shadow: 0 8px 20px rgba(251, 206, 30, 0.08);
        }

        .time-select-group { display: flex; gap: 5px; }
        .time-select-group select { padding: 0 8px; font-size: 0.85rem; height: 46px; width: 60px; text-align: center; }

        .note-cell textarea {
            height: 46px;
            min-height: 46px;
            max-height: 200px;
            resize: none;
            font-size: 0.85rem;
            line-height: 1.6;
            padding: 11px 14px;
            display: block;
            overflow: hidden;
            background: #fcfcfc;
        }
        .note-cell textarea:focus { overflow-y: auto; }

        .btn-add-item {
            background: #fffdf5;
            color: var(--accent-orange);
            border: 2px dashed var(--primary-yellow);
            padding: 16px;
            border-radius: 16px;
            width: 100%;
            cursor: pointer;
            font-weight: 700;
            margin-top: 10px;
        }

        /* --- Step 4 ç¾å­¸é‡æ§‹ V4.6 --- */
        .split-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            height: 100%;
            overflow: hidden;
        }
        .split-col-left {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
            padding-right: 0;
        }
        .split-col-right {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .member-mini-pill {
            display: inline-flex;
            align-items: center;
            background: white;
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
            font-weight: 700;
            color: #334155;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .member-mini-pill:hover { border-color: var(--teal-main); color: var(--teal-main); }
        .add-member-btn {
            width: 28px; height: 28px;
            border-radius: 50%;
            background: var(--teal-main);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
        }

        .settlement-card {
            flex: 1;
            background: var(--dark-card-bg);
            border-radius: 20px;
            padding: 20px;
            color: white;
            box-shadow: 0 15px 30px rgba(15, 23, 42, 0.2);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .settlement-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }

        .settlement-step {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.05);
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--teal-main);
            font-size: 0.85rem;
            backdrop-filter: blur(5px);
        }
        .settlement-step.to-banker { border-color: #f43f5e; }
        .settlement-step strong { color: var(--primary-yellow); font-size: 1rem; }

        .split-item-card {
            background: white;
            border: 1px solid #f1f5f9;
            border-radius: 20px;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: all 0.2s;
            position: relative;
        }
        .split-item-card:hover { border-color: var(--teal-main); box-shadow: 0 5px 15px rgba(20, 184, 166, 0.08); }
        
        .split-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 12px;
        }
        .split-name { font-size: 1.05rem; font-weight: 800; color: #334155; }
        .split-amount { font-size: 1.2rem; font-weight: 800; color: var(--teal-main); }
        .split-sub { font-size: 0.75rem; color: #94a3b8; font-weight: 700; margin-left: 8px; }

        .split-unified-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            overflow-x: auto; /* æ‰‹æ©Ÿç‰ˆæ©«å‘æ»‘å‹• */
        }
        
        .payer-select-container {
            position: relative;
            min-width: 110px;
        }
        .payer-custom-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            height: 34px;
        }
        .payer-custom-button:hover {
            border-color: var(--teal-main);
            color: var(--teal-main);
            box-shadow: 0 2px 5px rgba(20, 184, 166, 0.1);
        }
        .payer-avatar-badge {
            width: 20px; height: 20px;
            border-radius: 50%;
            background: var(--teal-main);
            color: white;
            font-size: 10px;
            font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .payer-name-display {
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }
        .payer-chevron {
            width: 10px; height: 10px;
            opacity: 0.5;
            flex-shrink: 0;
        }
        .native-select-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
            appearance: none;
        }

        .vertical-divider {
            width: 1px; height: 24px; background: #e2e8f0;
        }

        .members-scroll-area {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow-x: auto;
            flex: 1;
            scrollbar-width: none;
        }
        .members-scroll-area::-webkit-scrollbar { display: none; }

        .split-member-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            background: white;
            color: #94a3b8;
            border-color: #e2e8f0;
            white-space: nowrap;
        }
        .split-member-pill:hover { color: var(--teal-main); border-color: var(--teal-main); }
        .split-member-pill.active {
            background: var(--teal-light);
            color: var(--teal-main);
            border-color: var(--teal-main);
        }
        
        .mini-input {
            width: 50px;
            height: 22px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
            font-size: 0.75rem;
            padding: 0 4px;
            color: var(--primary-dark);
            background: rgba(255,255,255,0.8);
        }

        /* æ˜Ÿç©ºç•«å¸ƒå®¹å™¨ */
        #constellation-container {
            flex: 1;
            width: 100%;
            background: radial-gradient(circle at center, #0f172a 0%, #01040a 100%);
            border-radius: 35px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            min-height: 400px;
        }
        canvas { width: 100%; height: 100%; display: block; }

        .const-info {
            position: absolute;
            top: 35px;
            left: 45px;
            color: white;
            pointer-events: none;
            z-index: 10;
        }

        footer {
            height: var(--footer-height);
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom); /* é©é…æ‰‹æ©Ÿåº•éƒ¨ */
        }
        .footer-pill {
            background: var(--primary-dark);
            color: white;
            padding: 12px 40px;
            border-radius: 50px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .v-badge-alt {
            background: var(--primary-yellow);
            color: var(--primary-dark);
            padding: 2px 10px;
            border-radius: 10px;
            font-weight: 800;
            font-size: 0.75rem;
        }

        /* Responsive Breakpoints */
        @media (max-width: 1100px) {
            .split-layout { grid-template-columns: 1fr; }
            .split-col-left { max-height: 300px; flex-shrink: 0; }
        }
        
        @media (max-width: 768px) {
            nav { padding: 0 15px; }
            .nav-steps { gap: 6px; }
            .step-btn { padding: 6px 12px; font-size: 0.75rem; }
            .nav-utils { display: none; /* æ‰‹æ©Ÿç‰ˆéš±è—åŒ¯å…¥åŒ¯å‡ºä»¥ç¯€çœç©ºé–“ï¼Œæˆ–ç§»è‡³æ¼¢å ¡é¸å–® */ }
            
            .item-row { 
                grid-template-columns: 1fr; 
                gap: 10px;
                padding: 15px;
            }
            .time-select-group, .note-cell, .btn-del { width: 100%; }
            .note-cell textarea { height: 60px; }
            
            .day-tabs-container { padding: 10px 0; }
            
            #constellation-container { min-height: 300px; }
            .split-unified-bar { flex-direction: column; align-items: flex-start; }
            .vertical-divider { display: none; }
            .members-scroll-area { width: 100%; }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-steps">
        <button class="step-btn active" id="btn-s1" onclick="goStep(1)">1. è—åœ–</button>
        <button class="step-btn" id="btn-s2" onclick="goStep(2)">2. ç´°ç¯€</button>
        <button class="step-btn" id="btn-s3" onclick="goStep(3)">3. æ˜Ÿåœ–</button>
        <button class="step-btn" id="btn-s4" onclick="goStep(4)">4. çµç®—</button>
    </div>
    <div class="nav-utils">
        <button class="util-btn" onclick="exportData()"><span>ğŸ“¤</span> åŒ¯å‡º</button>
        <button class="util-btn" onclick="document.getElementById('importFile').click()"><span>ğŸ“¥</span> åŒ¯å…¥</button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
    </div>
</nav>

<div class="container" id="main-container">
    <!-- STEP 1: è—åœ– -->
    <div id="step-1" class="section active">
        <div class="card">
            <h2 style="display: flex; align-items: center; gap: 10px;">â˜€ï¸ å†’éšªå•Ÿèˆªåº§æ¨™</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div style="grid-column: 1 / -1;">
                    <label style="font-weight:700; color:#64748b; margin-bottom:8px; display:block;">æ—…ç¨‹ä¸»é¡Œ</label>
                    <input type="text" id="main-dest" placeholder="ä¾‹å¦‚ï¼šæ¼«æ­¥æ«»èŠ±å­£ä¹‹æ—…">
                </div>
                <div>
                    <label style="font-weight:700; color:#64748b; margin-bottom:8px; display:block;">å‡ºç™¼</label>
                    <input type="date" id="start-date">
                </div>
                <div>
                    <label style="font-weight:700; color:#64748b; margin-bottom:8px; display:block;">çµæŸ</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            <button class="btn-main" style="margin-top: 30px;" onclick="calculateDates()">å‰å¾€è¦åŠƒç´°ç¯€ â”</button>
        </div>
    </div>

    <!-- STEP 2: æ·±åº¦ç´°ç¯€ -->
    <div id="step-2" class="section">
        <div class="card" style="margin-bottom: 15px; border-left: 10px solid var(--primary-yellow); padding: 20px;">
            <h2 id="blueprint-title" style="margin:0;">è¡Œç¨‹ç´°éƒ¨è¦åŠƒ</h2>
        </div>
        
        <div class="day-nav-wrapper">
            <button class="nav-arrow" id="prevDayBtn" onclick="navigateDay(-1)">â®</button>
            <div class="day-tabs-container" id="day-tabs-bar"></div>
            <button class="nav-arrow" id="nextDayBtn" onclick="navigateDay(1)">â¯</button>
        </div>

        <div id="day-contents-container" style="flex: 1; min-height: 0; overflow-y: auto; padding-bottom: 20px;"></div>
        <button class="btn-main" style="background: var(--primary-dark); color: white; margin-top: 10px;" onclick="goStep(3)">è§€æ¸¬å‹•æ…‹æ˜Ÿè±¡å„€ â”</button>
    </div>

    <!-- STEP 3: æ˜Ÿåœ– -->
    <div id="step-3" class="section" style="overflow: hidden;">
        <div id="constellation-container">
            <canvas id="starCanvas"></canvas>
            <div class="const-info">
                <h2 id="const-dest-name" style="color: white; font-size: 2.2rem; margin: 0 0 10px 0; text-shadow: 0 4px 15px rgba(0,0,0,0.6);"></h2>
                <p id="const-type-label" style="opacity: 0.95; font-size: 1.1rem; letter-spacing: 2px; margin: 0; font-weight: 700; background: rgba(251, 206, 30, 0.15); backdrop-filter: blur(5px); padding: 8px 20px; border-radius: 50px; display: inline-block; color: var(--primary-yellow); border: 1px solid rgba(251, 206, 30, 0.3);"></p>
            </div>
        </div>
        
        <div class="card" style="display: grid; grid-template-columns: repeat(2, 1fr); text-align: center; margin-bottom: 0; padding: 20px;">
            <div><small style="color:#64748b; font-weight:700;">å†’éšªè·¨åº¦</small><br><strong id="final-days" style="font-size:1.4rem;">0</strong> <small>Days</small></div>
            <div><small style="color:#64748b; font-weight:700;">æ—…ç¨‹èƒ½é‡</small><br><strong id="final-budget" style="font-size:1.4rem; color:var(--accent-orange);">$0</strong></div>
        </div>
    </div>

    <!-- STEP 4: ç¶“è²»çµç®— -->
    <div id="step-4" class="section">
        <div class="split-layout">
            <!-- å·¦æ¬„ï¼šæˆå“¡èˆ‡å ±å‘Š -->
            <div class="split-col-left">
                <div class="card" style="padding: 15px; margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; font-size:1rem; color:#0d9488;">ğŸ‘¥ æ—…ä¼´</h3>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="new-member-name" placeholder="Name" style="width:80px; padding:4px 8px; height:28px; font-size:0.8rem;">
                            <button class="add-member-btn" onclick="addMember()">+</button>
                        </div>
                    </div>
                    <div id="members-list" class="members-compact-container"></div>
                </div>

                <div class="settlement-card">
                    <h3 style="margin-top:0; color:#14b8a6; display:flex; align-items:center; gap:8px; font-size:1.1rem; margin-bottom: 15px;">
                        <span>ğŸ“Š</span> æ™ºæ…§çµç®—
                    </h3>
                    <div id="settlement-report" style="flex:1; overflow-y:auto; padding-right:5px;">
                        <p style="opacity:0.5; font-size:0.85rem; text-align:center;">æ·»åŠ æˆå“¡ä¸¦è¨­å®šå¸³ç›®å¾Œç”Ÿæˆ...</p>
                    </div>
                </div>
            </div>

            <!-- å³æ¬„ï¼šå¸³ç›®æ¸…å–® -->
            <div class="split-col-right">
                <div class="day-nav-wrapper" id="split-day-nav-wrapper">
                    <!-- è‡ªå‹•åŒæ­¥ Step 2 å°èˆª -->
                </div>
                <div id="split-expenses-list-container" style="flex:1; overflow-y:auto; padding-bottom:20px;">
                    <div id="split-expenses-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-pill">
        Developed By: Daniel Shih <span>|</span> @2026 <span>|</span> <div class="v-badge-alt">V5.0</div>
    </div>
</footer>

<script>
    const state = {
        dest: "", startDate: null, endDate: null, daysCount: 0, dayData: [],
        activeDay: 1,
        activeSplitDay: 1,
        members: [{id: 'm1', name: 'æˆ‘'}],
        splitData: {} 
    };

    let canvas, ctx, animationId;
    let stars = [];
    let starDust = [];
    const categories = [
        { id: 'eat', label: 'ğŸ½ï¸ ç¾é£Ÿæ­£é¤', color: '#fbbf24' },
        { id: 'play', label: 'ğŸ“· æ™¯é»æ¢è¨ª', color: '#38bdf8' },
        { id: 'stay', label: 'ğŸ¨ é£¯åº—ä½å®¿', color: '#f472b6' },
        { id: 'buy', label: 'ğŸ›ï¸ è³¼ç‰©æ…¾æœ›', color: '#4ade80' },
        { id: 'move', label: 'ğŸš— äº¤é€šæ¥é§', color: '#a78bfa' },
        { id: 'event', label: 'ğŸ¡ æ´»å‹•é«”é©—', color: '#f97316' }
    ];

    function goStep(n) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
        document.getElementById(`btn-s${n}`).classList.add('active');
        
        const container = document.getElementById('main-container');
        
        if (n === 3) {
            container.style.overflowY = "hidden";
            setTimeout(() => {
                const cContainer = document.getElementById('constellation-container');
                const canvasEl = document.getElementById('starCanvas');
                if(cContainer && canvasEl) {
                    canvasEl.width = cContainer.offsetWidth;
                    canvasEl.height = cContainer.offsetHeight;
                    initConstellation();
                }
            }, 100); 
        } else {
            container.style.overflowY = "auto";
            if(animationId) cancelAnimationFrame(animationId);
        }

        if (n === 4) {
            initSettlement();
        }
    }

    // --- STEP 1 & 2 Logic ---
    function calculateDates() {
        const dest = document.getElementById('main-dest').value;
        const startStr = document.getElementById('start-date').value;
        const endStr = document.getElementById('end-date').value;
        if (!dest || !startStr || !endStr) return;
        const start = new Date(startStr);
        const end = new Date(endStr);
        if (end < start) return;
        state.dest = dest; state.startDate = startStr; state.endDate = endStr;
        state.daysCount = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
        state.dayData = []; 
        buildUI(); goStep(2);
    }

    function buildUI() {
        const tabsContainer = document.getElementById('day-tabs-bar');
        const contentsContainer = document.getElementById('day-contents-container');
        tabsContainer.innerHTML = ''; contentsContainer.innerHTML = '';
        document.getElementById('blueprint-title').innerText = `${state.dest} (${state.daysCount} å¤©)`;

        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        let foundTodayIdx = 1;

        const [startY, startM, startD] = state.startDate.split('-').map(Number);
        const startObj = new Date(startY, startM - 1, startD);

        for (let i = 1; i <= state.daysCount; i++) {
            const currentDay = new Date(startObj);
            currentDay.setDate(startObj.getDate() + (i - 1));
            
            const curY = currentDay.getFullYear();
            const curM = String(currentDay.getMonth() + 1).padStart(2, '0');
            const curD = String(currentDay.getDate()).padStart(2, '0');
            const currentDateStr = `${curY}-${curM}-${curD}`;
            const isToday = currentDateStr === todayStr;
            if(isToday) foundTodayIdx = i;

            const dateLabel = `${currentDay.getMonth() + 1}/${currentDay.getDate()}`;
            const tab = document.createElement('button');
            tab.className = `day-tab ${isToday ? 'is-today' : ''}`;
            tab.id = `tab-d${i}`;
            tab.innerHTML = `Day ${i} <span style="font-size:0.75rem; opacity:0.7">(${dateLabel})</span>`;
            tab.onclick = () => switchDay(i);
            tabsContainer.appendChild(tab);

            const content = document.createElement('div');
            content.className = `day-content`;
            content.style.display = 'none'; 
            content.id = `content-d${i}`;
            content.innerHTML = `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;"><h3 style="margin:0; font-size:1.1rem;">âœ¨ ç¬¬ ${i} å¤© Â· è¡Œç¨‹è¦åŠƒ</h3><span id="day-total-${i}" style="font-weight:800; color:var(--accent-orange); font-size:1.1rem;">$0</span></div><div id="item-list-${i}"></div><button class="btn-add-item" onclick="addItem(${i})">ï¼‹ æ–°å¢è¡Œç¨‹èƒ½é‡é»</button></div>`;
            contentsContainer.appendChild(content);
            if(!state.dayData[i-1]) state.dayData[i-1] = { dayIndex: i, dateLabel: dateLabel, items: [] };
            renderItems(i);
        }
        switchDay(foundTodayIdx);
        state.activeSplitDay = foundTodayIdx; 
    }

    function switchDay(n) {
        state.activeDay = n;
        document.querySelectorAll('#day-tabs-bar .day-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.day-content').forEach(c => c.style.display = 'none');
        const activeTab = document.getElementById(`tab-d${n}`);
        if(activeTab) { activeTab.classList.add('active'); activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }
        const activeContent = document.getElementById(`content-d${n}`);
        if(activeContent) activeContent.style.display = 'block';
        document.getElementById('day-contents-container').scrollTop = 0;
        updateArrowStates();
    }

    function navigateDay(offset) {
        let target = state.activeDay + offset;
        if(target >= 1 && target <= state.daysCount) switchDay(target);
    }

    function updateArrowStates() {
        const prev = document.getElementById('prevDayBtn');
        const next = document.getElementById('nextDayBtn');
        if(prev) prev.disabled = state.activeDay <= 1;
        if(next) next.disabled = state.activeDay >= state.daysCount;
    }

    function addItem(dayNum) {
        const day = state.dayData[dayNum-1];
        const id = Date.now() + Math.random();
        day.items.push({ id: id, hour: '09', minute: '00', name: '', note: '', cat: 'play', amt: 0 });
        renderItems(dayNum);
    }

    function updateItem(dayNum, itemId, field, value) {
        const item = state.dayData[dayNum-1].items.find(i => i.id === itemId);
        item[field] = field === 'amt' ? (parseFloat(value) || 0) : value;
        if (field === 'hour' || field === 'minute') {
            state.dayData[dayNum-1].items.sort((a, b) => `${a.hour}:${a.minute}`.localeCompare(`${b.hour}:${b.minute}`));
            renderItems(dayNum);
        } else calculateDayTotal(dayNum);
    }

    function removeItem(dayNum, itemId) {
        state.dayData[dayNum-1].items = state.dayData[dayNum-1].items.filter(i => i.id !== itemId);
        renderItems(dayNum);
    }

    function renderItems(dayNum) {
        const container = document.getElementById(`item-list-${dayNum}`);
        if (!container) return;
        container.innerHTML = '';
        state.dayData[dayNum-1].items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'item-row';
            let hourOpts = Array.from({length: 24}, (_, h) => { const s = h.toString().padStart(2,'0'); return `<option value="${s}" ${item.hour==s?'selected':''}>${s}</option>`; }).join('');
            let catOpts = categories.map(c => `<option value="${c.id}" ${item.cat==c.id?'selected':''}>${c.label}</option>`).join('');
            row.innerHTML = `<div class="time-select-group"><select onchange="updateItem(${dayNum},${item.id},'hour',this.value)">${hourOpts}</select><select onchange="updateItem(${dayNum},${item.id},'minute',this.value)"><option value="00" ${item.minute=='00'?'selected':''}>00</option><option value="30" ${item.minute=='30'?'selected':''}>30</option></select></div><input type="text" placeholder="è¡Œç¨‹åç¨±..." value="${item.name}" oninput="updateItem(${dayNum},${item.id},'name',this.value)"><select onchange="updateItem(${dayNum},${item.id},'cat',this.value)">${catOpts}</select><div class="note-cell"><textarea placeholder="å‚™è¨»..." oninput="autoHeight(this); updateItem(${dayNum},${item.id},'note',this.value)">${item.note}</textarea></div><input type="number" placeholder="é ç®—" value="${item.amt||''}" oninput="updateItem(${dayNum},${item.id},'amt',this.value)"><button class="btn-del" onclick="removeItem(${dayNum},${item.id})" style="color:#ef4444; border:none; background:none; cursor:pointer; font-size:1.2rem;">âœ•</button>`;
            container.appendChild(row);
            autoHeight(row.querySelector('textarea'));
        });
        calculateDayTotal(dayNum);
    }

    function autoHeight(el) { if(!el) return; el.style.height = "46px"; const newHeight = el.scrollHeight; if (newHeight > 46) { el.style.height = newHeight + "px"; } }
    function calculateDayTotal(dayNum) { const total = state.dayData[dayNum-1].items.reduce((sum, i) => sum + (i.amt || 0), 0); const el = document.getElementById(`day-total-${dayNum}`); if(el) el.innerText = `$${total.toLocaleString()}`; }

    // --- STEP 4 æ‹†å¸³é‚è¼¯ ---
    function initSettlement() {
        syncSplitDayNav();
        renderMembers();
        renderSplitList();
        calculateSettlement();
    }

    function syncSplitDayNav() {
        const wrapper = document.getElementById('split-day-nav-wrapper');
        const originalNav = document.querySelector('.day-nav-wrapper').innerHTML;
        wrapper.innerHTML = originalNav;
        
        const arrows = wrapper.querySelectorAll('.nav-arrow');
        arrows[0].id = "split-prevBtn"; arrows[0].onclick = () => navigateSplitDay(-1);
        arrows[1].id = "split-nextBtn"; arrows[1].onclick = () => navigateSplitDay(1);
        
        const tabs = wrapper.querySelectorAll('.day-tab');
        tabs.forEach((tab, idx) => {
            const dayNum = idx + 1;
            tab.id = `split-tab-d${dayNum}`;
            tab.onclick = () => switchSplitDay(dayNum);
        });
        updateSplitNavUI();
    }

    function switchSplitDay(n) {
        state.activeSplitDay = n;
        updateSplitNavUI();
        renderSplitList();
    }

    function navigateSplitDay(offset) {
        let target = state.activeSplitDay + offset;
        if(target >= 1 && target <= state.daysCount) switchSplitDay(target);
    }

    function updateSplitNavUI() {
        const wrapper = document.getElementById('split-day-nav-wrapper');
        wrapper.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
        const activeTab = document.getElementById(`split-tab-d${state.activeSplitDay}`);
        if(activeTab) {
            activeTab.classList.add('active');
            activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
        document.getElementById('split-prevBtn').disabled = state.activeSplitDay <= 1;
        document.getElementById('split-nextBtn').disabled = state.activeSplitDay >= state.daysCount;
    }

    function addMember() {
        const name = document.getElementById('new-member-name').value.trim();
        if(name) {
            state.members.push({ id: 'm' + Date.now(), name: name });
            document.getElementById('new-member-name').value = '';
            initSettlement();
        }
    }

    function removeMember(id) {
        if(state.members.length <= 1) return;
        state.members = state.members.filter(m => m.id !== id);
        initSettlement();
    }

    function renderMembers() {
        const container = document.getElementById('members-list');
        container.innerHTML = state.members.map(m => `
            <div class="member-mini-pill">
                ${m.name}
                ${state.members.length > 1 ? `<span onclick="removeMember('${m.id}')" style="cursor:pointer; margin-left:6px; color:#ef4444; font-weight:bold;">Ã—</span>` : ''}
            </div>
        `).join('');
    }

    function renderSplitList() {
        const container = document.getElementById('split-expenses-list');
        container.innerHTML = '';
        
        const currentDayItems = state.dayData[state.activeSplitDay - 1]?.items.filter(i => i.name && i.amt > 0) || [];

        if(currentDayItems.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8; font-weight:700;">Day ${state.activeSplitDay} å°šæœªæœ‰è¡Œç¨‹æ”¯å‡º</div>`;
            return;
        }

        currentDayItems.forEach(item => {
            if(!state.splitData[item.id]) {
                const initialSplits = {};
                state.members.forEach(m => initialSplits[m.id] = { involved: true, amount: '', isFixed: false });
                state.splitData[item.id] = { payerId: state.members[0].id, splits: initialSplits };
            }
            const split = state.splitData[item.id];
            
            // Sync members
            state.members.forEach(m => {
                if(!split.splits[m.id]) split.splits[m.id] = { involved: true, amount: '', isFixed: false };
            });

            // Calc dynamic share
            let fixedSum = 0;
            let dynamicCount = 0;
            Object.values(split.splits).forEach(s => {
                if(s.involved) {
                    if(s.amount !== '' && !isNaN(s.amount)) fixedSum += parseFloat(s.amount);
                    else dynamicCount++;
                }
            });
            const share = dynamicCount > 0 ? Math.max(0, (item.amt - fixedSum) / dynamicCount) : 0;

            const membersHtml = state.members.map(m => {
                const s = split.splits[m.id];
                const isActive = s.involved;
                return `
                    <div class="split-member-pill ${isActive ? 'active' : ''}" onclick="toggleSplitInvolved(event, '${item.id}', '${m.id}')">
                        <span>${m.name}</span>
                        ${isActive ? `
                            <input type="number" value="${s.amount}" placeholder="$${share.toFixed(0)}"
                                class="mini-input"
                                onclick="event.stopPropagation()"
                                onchange="updateFixedAmount('${item.id}', '${m.id}', this.value)">
                        ` : ''}
                    </div>
                `;
            }).join('');

            const payerOpts = state.members.map(m => `<option value="${m.id}" ${split.payerId===m.id?'selected':''}>${m.name}</option>`).join('');
            const currentPayerName = state.members.find(m => m.id === split.payerId)?.name || 'è«‹é¸æ“‡';

            const card = document.createElement('div');
            card.className = 'split-item-card';
            card.innerHTML = `
                <div class="split-header-row">
                    <div>
                        <div class="split-name">${item.name} <span class="split-sub">å‰©é¤˜å‡åˆ†: $${share.toFixed(0)}</span></div>
                    </div>
                    <div class="split-amount">$${item.amt.toLocaleString()}</div>
                </div>
                
                <div class="split-unified-bar">
                    <div class="payer-select-container">
                        <div class="payer-custom-button">
                            <div class="payer-avatar-badge">å¢Š</div>
                            <span class="payer-name-display">${currentPayerName}</span>
                            <svg class="payer-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <select class="native-select-overlay" onchange="updateSplitPayer('${item.id}', this.value)">${payerOpts}</select>
                    </div>
                    
                    <div class="vertical-divider"></div>
                    
                    <div class="members-scroll-area">
                        ${membersHtml}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function toggleSplitInvolved(e, itemId, mid) {
        if(e.target.tagName === 'INPUT') return; 
        const s = state.splitData[itemId].splits[mid];
        s.involved = !s.involved;
        if(!s.involved) s.amount = '';
        renderSplitList();
        calculateSettlement();
    }

    function updateFixedAmount(itemId, mid, val) {
        state.splitData[itemId].splits[mid].amount = val;
        calculateSettlement();
        renderSplitList(); 
    }

    function updateSplitPayer(itemId, pid) {
        state.splitData[itemId].payerId = pid;
        calculateSettlement();
        renderSplitList(); 
    }

    function calculateSettlement() {
        const balances = {};
        state.members.forEach(m => balances[m.id] = 0);

        state.dayData.forEach(day => {
            day.items.forEach(item => {
                if(item.name && item.amt > 0) {
                    const splitObj = state.splitData[item.id];
                    if(!splitObj) return;

                    balances[splitObj.payerId] += item.amt;

                    let fixedSum = 0;
                    let dynamicCount = 0;
                    Object.entries(splitObj.splits).forEach(([mid, s]) => {
                        if(state.members.find(m=>m.id===mid) && s.involved) {
                            if(s.amount !== '' && !isNaN(s.amount)) {
                                const fv = parseFloat(s.amount);
                                fixedSum += fv;
                                balances[mid] -= fv;
                            } else {
                                dynamicCount++;
                            }
                        }
                    });
                    
                    const share = dynamicCount > 0 ? (item.amt - fixedSum) / dynamicCount : 0;
                    Object.entries(splitObj.splits).forEach(([mid, s]) => {
                        if(state.members.find(m=>m.id===mid) && s.involved && (s.amount === '' || isNaN(s.amount))) {
                            balances[mid] -= share;
                        }
                    });
                }
            });
        });

        const reportDiv = document.getElementById('settlement-report');
        const balArr = state.members.map(m => ({ ...m, bal: balances[m.id] })).sort((a,b) => b.bal - a.bal);
        const banker = balArr[0];

        if(!banker || Math.abs(banker.bal) < 1) {
            reportDiv.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.5;">ç›®å‰å¸³ç›®å¹³è¡¡ ğŸ‰</div>`;
            return;
        }

        let html = `<div style="margin-bottom:15px; padding:12px; background:rgba(255,255,255,0.1); border-radius:12px; font-weight:700; border:1px solid rgba(255,255,255,0.2);">
            ğŸ‘‘ Banker: <span style="color:var(--primary-yellow);">${banker.name}</span>
        </div>`;

        balArr.filter(m => m.bal < -0.5).forEach(m => {
            html += `<div class="settlement-step to-banker"><span>${m.name}</span> <span>â” ${banker.name}</span> <strong>$${Math.abs(m.bal).toFixed(0)}</strong></div>`;
        });

        balArr.filter(m => m.bal > 0.5 && m.id !== banker.id).forEach(m => {
            html += `<div class="settlement-step"><span>${banker.name}</span> <span>â” ${m.name}</span> <strong>$${m.bal.toFixed(0)}</strong></div>`;
        });

        reportDiv.innerHTML = html;
    }

    function exportData() { const blob = new Blob([JSON.stringify(state)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `TripPlan_V5.0.json`; a.click(); }
    function importData(e) { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (ev) => { const data = JSON.parse(ev.target.result); Object.assign(state, data); document.getElementById('main-dest').value = state.dest; document.getElementById('start-date').value = state.startDate; document.getElementById('end-date').value = state.endDate; buildUI(); goStep(2); }; reader.readAsText(file); }
    function generateSoulTitle(summary) {
        const sortedCats = Object.keys(summary).sort((a, b) => summary[b] - summary[a]);
        const main = sortedCats[0]; const sub = sortedCats[1];
        const totalAll = Object.values(summary).reduce((a, b) => a + b, 0);
        if (totalAll === 0) return "å•Ÿç¨‹å‰çš„ç©ºéˆæ—…è€…";
        const titlePool = {
            eat: { play: ["è–é¤ç´šæ¢éšªå®¶", "èˆŒå°–ä¸Šçš„å¥§å¾·è³½"], stay: ["æ„Ÿå®˜äº«æ¨‚å›ç‹", "è‡¥æ¦»ç¾é£Ÿå®¶"], buy: ["æ–‡æ˜éºç”¢æ”¶å‰²è€…", "æµå‹•ç››å®´æ”¶è—å®¶"], move: ["ç–¾èµ°å‘³è•¾çµæ‰‹", "é¢¨ä¸­ç¾å‘³å…ˆçŸ¥"], event: ["å¤šå·´èƒºç¥­å¸", "é¥—å®´æŒ‡æ®å®¶"] },
            play: { eat: ["è’é‡è–å¾’", "å¥½å¥‡å¿ƒç¥­å£‡"], stay: ["éœä¿®å®¤æ¢éšªè€…", "å®‰çœ çµäºº"], buy: ["å¥‡è§€æˆ°åˆ©å“å¤§å¸«", "æ­·å²ç¢ç‰‡æ”¶é›†è€…"], move: ["æ°¸æ†è¿½å…‰è€…", "åœ°å¹³ç·šä¿¡å¾’"], event: ["éˆé­‚æ…¶å…¸é–‹æ‹“è€…", "ç¬é–“æ°¸æ†å¯¦è¸è€…"] },
            stay: { eat: ["å®®å»·å¼å¤¢éŠè€…", "æ²ˆæ€é£Ÿå®¢"], play: ["èˆ’é©å€å†’éšªå®¶", "æ•é‚Šæ˜Ÿç©ºå®ˆè¡›"], buy: ["ç²¾å“å±…æ‰€éš±å£«", "ç©ºé–“ç¾å­¸å…¸è—"], move: ["ç§»å‹•å®®æ®¿é ˜ä¸»", "æš«å±…äººé–“çš„é¢¨"], event: ["å¤¢å¢ƒåŠ‡å ´åƒèˆ‡è€…", "éœæ…‹ç‹‚æ­¡è€…"] },
            buy: { eat: ["ç‰©è³ªé£Ÿæ…¾äºŒé‡å¥", "æ“æœ‰æ„Ÿå®˜éŠ€è¡Œå®¶"], play: ["æˆ°åˆ©å“æ”¶è—å®¶", "è£é€²èƒŒåŒ…çš„ä¸–ç•Œ"], stay: ["å¥¢è¯å±…æ‰€æ“æœ‰è€…", "ç‰©æ¬Šç¾å­¸ç¥­å¸"], move: ["ç§»å‹•å¼ç²¾å“åº—", "åœ°åœ–æƒè²¨çµäºº"], event: ["ç‹‚ç†±æ…¶å…¸è²·å–®è€…", "å›æ†¶è³‡ç”¢ç®¡ç†äºº"] },
            move: { eat: ["å…¬è·¯ç±³å…¶æ—", "è·¨è¶Šæ™‚å€é£¢é¤“æ„Ÿ"], play: ["åº§æ¨™é–ƒé›»çµæ‰‹", "ä¸åœæ­‡æ¢éšªæ„å¿—"], stay: ["å¼•æ“è²ä¸­ç¡çœ è€…", "é¢¨ä¸­æ—…é¤¨å®¿ä¸»"], buy: ["ç©¿æ¢­ä¸–ç•Œæ¬é‹å·¥", "æ™‚å°šéŠä¿ "], event: ["å‹•æ…‹ç”Ÿæ´»å°èˆªå“¡", "æ•æ‰ç¬é–“æ”å½±å¸«"] },
            event: { eat: ["èˆŒå°–ä¸Šçš„æ…¶å…¸", "ç¥è–ç¤¾äº¤é£Ÿå®¢"], play: ["æ´»å‹•æ”»ç•¥çµ„", "ç¤¾ç¾¤åƒ¹å€¼é–‹æ‹“è€…"], stay: ["æ²‰æµ¸å¼å±…ä½å“²äºº", "å˜‰å¹´è¯é¿é¢¨æ¸¯"], buy: ["å›æ†¶ç¢ç‰‡æ”¶è—è€…", "æƒ…æ„Ÿè³‡ç”¢æŒæœ‰è€…"], move: ["è¶•å ´ç†±è¡€æ—…äºº", "åº§æ¨™é–“æ­¡æ¨‚å…‰æŸ"] }
        };
        const list = titlePool[main][sub] || ["è‡ªç”±æ˜Ÿç³»æ—…äºº"];
        return list[Math.floor(Math.random() * list.length)];
    }
    
    function initConstellation() {
        canvas = document.getElementById('starCanvas'); ctx = canvas.getContext('2d');
        const container = document.getElementById('constellation-container');
        if(!container) return; // Safety check
        canvas.width = container.offsetWidth; canvas.height = container.offsetHeight;
        const cx = canvas.width / 2; const cy = canvas.height / 2;

        stars = Array.from({length: 46}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: 0.8 + Math.random() * 1.5, o: Math.random(), sp: 0.005 + Math.random() * 0.015 }));
        starDust = Array.from({length: 58}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: Math.random() * 0.5, o: Math.random(), spY: 0.002 + Math.random() * 0.008 }));
        
        const summary = { eat: 0, stay: 0, play: 0, move: 0, buy: 0, event: 0 };
        let totalAll = 0;
        state.dayData.forEach(d => d.items.forEach(i => { if(summary[i.cat] !== undefined) { summary[i.cat] += i.amt; totalAll += i.amt; } }));

        document.getElementById('final-days').innerText = state.daysCount;
        document.getElementById('final-budget').innerText = `$${totalAll.toLocaleString()}`;
        document.getElementById('const-dest-name').innerText = state.dest || "æˆ‘çš„æœªçŸ¥å†’éšª";
        const soulTitle = generateSoulTitle(summary);
        document.getElementById('const-type-label').innerText = `${soulTitle}`;

        const sorted = Object.keys(summary).sort((a,b)=>summary[b]-summary[a]);
        const primaryColor = categories.find(c=>c.id===sorted[0])?.color || '#fbbf24';
        const secondaryColor = categories.find(c=>c.id===sorted[1])?.color || '#38bdf8';

        const safeMargin = 120; 
        const maxRadius = Math.min(canvas.width, canvas.height) / 2 - safeMargin;
        const baseDistFactor = maxRadius / (Math.min(canvas.width, canvas.height) / 2);

        const baseAngles = [-Math.PI/2, -Math.PI/6, Math.PI/6, Math.PI/2, 5*Math.PI/6, 7*Math.PI/6];
        const rawNodeData = [ {id:'stay', label:'ä½å®¿', val:summary.stay, color:'#f472b6'}, {id:'eat', label:'ç¾é£Ÿ', val:summary.eat, color:'#fbbf24'}, {id:'play', label:'æ¢è¨ª', val:summary.play, color:'#38bdf8'}, {id:'buy', label:'è³¼ç‰©', val:summary.buy, color:'#4ade80'}, {id:'move', label:'äº¤é€š', val:summary.move, color:'#a78bfa'}, {id:'event', label:'é«”é©—', val:summary.event, color:'#f97316'} ];

        const nodeData = rawNodeData.map((n, i) => {
            const r = totalAll > 0 ? (n.val / totalAll) : 0.15;
            const jitterAngle = (Math.random() - 0.5) * 1.1; 
            const jitterDist = 0.65 + Math.random() * 0.65; 
            return { ...n, angle: baseAngles[i] + jitterAngle, dist: baseDistFactor * jitterDist * (0.8 + r * 0.4) };
        });

        function drawSoftStar(x, y, size, color, opacity) {
            ctx.save(); ctx.translate(x, y);
            const g1 = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 3); g1.addColorStop(0, color + Math.floor(opacity * 60).toString(16).padStart(2, '0')); g1.addColorStop(1, 'transparent'); ctx.fillStyle = g1; ctx.beginPath(); ctx.arc(0, 0, size * 3, 0, Math.PI * 2); ctx.fill();
            const g2 = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 1.5); g2.addColorStop(0, color + Math.floor(opacity * 180).toString(16).padStart(2, '0')); g2.addColorStop(0.5, color + "00"); g2.addColorStop(1, 'transparent'); ctx.fillStyle = g2; ctx.beginPath(); ctx.arc(0, 0, size * 1.5, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = size / 2; ctx.shadowColor = "#fff"; ctx.fillStyle = "rgba(255, 255, 255, " + (opacity * 0.9) + ")"; ctx.beginPath(); ctx.arc(0, 0, 3 + size/15, 0, Math.PI * 2); ctx.fill(); ctx.restore();
        }

        let tick = 0;
        function animate() {
            tick += 0.0040;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            starDust.forEach(d => { d.y += d.spY; if(d.y > canvas.height) d.y = 0; ctx.fillStyle = `rgba(255,255,255,${0.02 + Math.sin(tick*1.5 + d.o)*0.02})`; ctx.beginPath(); ctx.arc(d.x, d.y, d.s, 0, Math.PI*2); ctx.fill(); });
            stars.forEach(s => { s.y += s.sp; if(s.y > canvas.height) s.y = 0; ctx.fillStyle=`rgba(255,255,255,${0.05 + Math.sin(tick*0.8 + s.o)*0.08})`; ctx.beginPath(); ctx.arc(s.x,s.y,s.s,0,Math.PI*2); ctx.fill(); });
            ctx.save(); ctx.beginPath();
            nodeData.forEach((n, i) => { const dynamicDist = n.dist + Math.sin(tick*0.3 + i)*0.0001; const px = cx + Math.cos(n.angle) * dynamicDist * (canvas.width/2); const py = cy + Math.sin(n.angle) * dynamicDist * (canvas.height/2); if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py); });
            ctx.closePath(); const nebulaGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxRadius * 1.8); nebulaGrad.addColorStop(0, primaryColor + '05'); nebulaGrad.addColorStop(0.8, secondaryColor + '01'); nebulaGrad.addColorStop(1, 'transparent'); ctx.fillStyle = nebulaGrad; ctx.globalCompositeOperation = "screen"; ctx.fill(); ctx.restore();
            nodeData.forEach((n, i) => { const r = totalAll > 0 ? (n.val / totalAll) : 0.15; const pulse = Math.sin(tick*1.5 + n.angle)*0.4; const size = 15 + r * 50 + pulse; const px = cx + Math.cos(n.angle) * n.dist * (canvas.width/2); const py = cy + Math.sin(n.angle) * n.dist * (canvas.height/2); drawSoftStar(px, py, size, n.color, 0.3 + r * 0.7); ctx.fillStyle="rgba(255,255,255,0.75)"; ctx.font="700 13px Quicksand, Noto Sans TC"; ctx.textAlign="center"; ctx.fillText(n.label, px, py - (size * 0.8) - 15); });
            animationId = requestAnimationFrame(animate);
        }
        animate();
    }
    
    window.addEventListener('resize', () => { if(document.getElementById('step-3').classList.contains('active')) initConstellation(); });
</script>

</body>
</html>